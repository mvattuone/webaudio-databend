<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Webaudio Databending</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.5/dat.gui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tunajs/1.0.0/tuna-min.js"></script>
    <script src="dist/databend.js"></script>
    <style>
      .upload {
        border: 1px solid #000;
        margin: 0 auto;
        width:500px;
        height:500px;
      }

      .upload {
        text-align: center;
      }

      .upload.hover {
        background-color: cyan;
      }

      label {
        display: block;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="upload">
      <p>Drop video here to databend</p>
    </div>
    <label><input type="file" /> Or upload a file</label>


    <script>
      function handleDatGUI(databent){
        var gui = new dat.GUI();
        Object.keys(databent.effects).forEach(function (effect) {
          if (effect === 'frameRate') { 
            gui.add(databent.effects, effect);
          } else {
            Object.keys(databent.effects[effect]).forEach(function (param) {
              if (param === 'active') {
                if (effect === 'playAudio') {
                  gui.add(databent.effects[effect], param)
                    .name("Toggle Audio");
                } else {
                  gui.add(databent.effects[effect], param)
                    .name("Enable " + effect);
                }
              } else {
                gui.add(databent.effects[effect], param)            
              }
            });
          }
        });
      }

      function renderVideoToCanvas(v,c,w,h) {
        var timer;
        var time;

        function drawFrame(v,c,w,h) {
          if(v.paused || v.ended) return false;
          c.drawImage(v,0,0,w,h);
          var imageData = c.getImageData(0,0,w,h);
          var databent = databender.bend(imageData).then(function(renderedBuffer) {
            databender.draw(renderedBuffer, c);
          });
        }

        (function repeat() {
          time = 1000 / databender.effects.frameRate;  
          drawFrame(v,c,w,h);
          timer = setTimeout(repeat, time);
        }());
      }

      function handleVideoUpload(e){
        var reader = new FileReader();
        var canvas = document.createElement('canvas');
        var context = canvas.getContext('2d');
        var video = document.createElement('video');
        video.addEventListener('loadedmetadata', function (event) {
          canvas.width = this.videoWidth; 
          canvas.height = this.videoHeight; 
        });
        video.addEventListener('play', function () {
          renderVideoToCanvas(this, context, canvas.width, canvas.height);
        }, false);
        reader.onload = function(event){
          video.src = this.result;
          video.type = "video/mp4";
          video.loop = true;
          video.play();
        }
        reader.readAsDataURL(e[0]);
      }

      function init() {
        hasGUI = false;
        audioCtx = new AudioContext();
        var upload = document.querySelector('.upload');
        var fileUpload = document.querySelector('input[type=file]');
        upload.ondragover = function () { this.classList.add('hover'); return false; };
        upload.ondragend = function () { this.classList.remove('hover'); return false; };
        upload.ondrop = function (e) {
          e.preventDefault();
          document.querySelector('.upload').style.display = 'none';
          handleVideoUpload(e.dataTransfer.files);
        }
        databender = new Databender(audioCtx);
        handleDatGUI(databender);
      };

      init();
    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-100494280-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
