<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Webaudio Databending</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.5/dat.gui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tunajs/1.0.0/tuna-min.js"></script>
    <script src="dist/databend.js"></script>
    <style>
      .upload {
        border: 1px solid #000;
        margin: 0 auto;
        width:500px;
        height:500px;
      }

      .upload {
        text-align: center;
      }

      .upload.hover {
        background-color: cyan;
      }

      label {
        display: block;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="upload">
      <p>Drop video here to databend</p>
    </div>
    <label><input type="file" /> Or upload a file</label>


    <script>
      var handleDatGUI = function(databent){
        var gui = new dat.GUI();
        Object.keys(databent.effects).forEach(function (effect) {
          Object.keys(databent.effects[effect]).forEach(function (param) {
            if (param === 'active') {
              if (effect === 'playAudio') {
                gui.add(databent.effects[effect], param)
                  .onFinishChange(function () {
                    databent.render();
                  })
                  .name("Toggle Audio");
              } else {
                gui.add(databent.effects[effect], param)
                  .onFinishChange(function () {
                    databent.render();
                  })
                  .name("Enable " + effect);
              }
            } else {
              gui.add(databent.effects[effect], param).onFinishChange(function () {
                databent.render();
              });
            }
          });
        });
      }

      function draw(v,c,w,h) {
        if(v.paused || v.ended) return false;
        c.drawImage(v,0,0,w,h);
        var imageData = c.getImageData(0,0,w,h);
        var databent = new Databender(imageData, audioCtx);
        if (!hasGUI) {
          handleDatGUI(databent);
          hasGUI = true;
        }
        if (databent.transformedImage) {
          databent.ctx.putImageData(databent.transformedImage, 0, 0);
        }
        setTimeout(draw,150,v,c,w,h);
      }

      function handleVideo(e){
        hasDatGUI = false;
        var reader = new FileReader();
        var _this = this;
        var canvas = document.createElement('canvas');
        canvas.width = 400;
        canvas.height = 400;
        var cw = canvas.width;
        var ch = canvas.height;
        var context = canvas.getContext('2d');
        var video = document.createElement('video');
        video.width = 400;
        video.height = 400;
        video.addEventListener('play', function () {
          draw(this, context, cw, ch);
        }, false);
        reader.onload = function(event){
          
          
          video.src = this.result;
          video.type = "video/mp4";
          video.loop = true;
          video.play();
        }
        reader.readAsDataURL(e[0]);
      }

      function init() {
        hasGUI = false;
        audioCtx = new AudioContext();
        var upload = document.querySelector('.upload');
        var fileUpload = document.querySelector('input[type=file]');
        upload.ondragover = function () { this.classList.add('hover'); return false; };
        upload.ondragend = function () { this.classList.remove('hover'); return false; };
        upload.ondrop = function (e) {
          e.preventDefault();
          this.classList.remove('upload');
          handleVideo(e.dataTransfer.files);
        }
      };

      init();
    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-100494280-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
