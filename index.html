<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Webaudio Databending</title>
    <script src="./dat.gui.min.js"></script>
    <script src="./tuna.js"></script>
    <script src="./databend.js"></script>
    <style>
      .upload {
        border: 1px solid #000;
        margin: 0 auto;
        width:500px;
        height:500px;
      }

      .upload {
        text-align: center;
      }

      .upload.hover {
        background-color: cyan;
      }
    </style>
  </head>
  <body>
    <div class="upload">
      <p>Drop image here to upload</p>
    </div>


    <script>
      function handleImage(e){
        var reader = new FileReader();
        var _this = this;
        reader.onload = function(event){
            var img = new Image();
            img.onload = function(){
              databent = new Databender(img);
              var gui = new dat.GUI();
              Object.keys(databent.effects).forEach(function (effect) {
                Object.keys(databent.effects[effect]).forEach(function (param) {
                  if (param === 'active') {
                    console.log(effect);
                    if (effect === 'playAudio') {
                      gui.add(databent.effects[effect], param)
                        .onFinishChange(function () {
                          databent.render();
                        })
                        .name("Toggle Audio");
                    } else {
                      gui.add(databent.effects[effect], param)
                        .onFinishChange(function () {
                          databent.render();
                        })
                        .name("Enable " + effect);
                    }
                  } else {
                    gui.add(databent.effects[effect], param).onFinishChange(function () {
                      databent.render();
                    });
                  }
                });
              });
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(e[0]);
      }

      function init() {
        var url = 'sample.mp3';
        var request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.responseType = 'arraybuffer';

        // Decode asynchronously
        request.onload = function() {
          window.track = request.response;
        }
        request.send();

        var upload = document.querySelector('.upload');
        upload.ondragover = function () { this.classList.add('hover'); return false; };
        upload.ondragend = function () { this.classList.remove('hover'); return false; };
        upload.ondrop = function (e) {
          e.preventDefault();
          this.classList.remove('upload');
          handleImage(e.dataTransfer.files);
        }
      };

      init();
    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-100494280-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
